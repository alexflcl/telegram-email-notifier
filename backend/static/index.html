<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Email Notifier</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 30px; 
            margin-bottom: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
        }
        h1 { color: #333; margin-bottom: 30px; font-size: 28px; }
        h2 { color: #667eea; margin: 20px 0 15px 0; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px; 
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1); 
        }
        .btn { 
            padding: 10px 20px; 
            background: #667eea; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn:hover { background: #5568d3; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .item { 
            background: #f9fafb; 
            padding: 15px; 
            border-radius: 6px; 
            margin-bottom: 10px; 
            border-left: 4px solid #667eea; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-content { flex: 1; }
        .item-title { font-weight: 600; color: #333; }
        .item-info { color: #666; font-size: 13px; margin-top: 5px; }
        .alert { 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 15px; 
        }
        .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ü§ñ Telegram Email Notifier</h1>
            <p style="color: #999;">Monitorea carpetas de email y env√≠a notificaciones autom√°ticas a Telegram</p>
        </div>

        <!-- Alerts -->
        <div id="alerts"></div>

        <!-- Bots -->
        <div class="card">
            <h2>ü§ñ Bots de Telegram</h2>
            <div class="grid">
                <div>
                    <div class="form-group">
                        <label>Nombre</label>
                        <input id="botName" placeholder="Mi Bot">
                    </div>
                    <div class="form-group">
                        <label>Token</label>
                        <input id="botToken" type="password" placeholder="Token de Telegram">
                    </div>
                    <div class="form-group">
                        <label>Chat ID</label>
                        <input id="botChatId" placeholder="ID del chat">
                    </div>
                    <button class="btn" onclick="addBot()">Agregar Bot</button>
                </div>
                <div id="botsList"></div>
            </div>
        </div>

        <!-- Emails -->
        <div class="card">
            <h2>üìß Cuentas de Email</h2>
            <div class="grid">
                <div>
                    <div class="form-group">
                        <label>Email</label>
                        <input id="emailAddr" type="email" placeholder="tu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a</label>
                        <input id="emailPass" type="password" placeholder="Contrase√±a o app password">
                    </div>
                    <div class="form-group">
                        <label>Servidor IMAP</label>
                        <input id="emailServer" placeholder="mail.example.com">
                    </div>
                    <div class="form-group">
                        <label>Puerto IMAP</label>
                        <input id="emailPort" type="number" value="993" placeholder="993">
                    </div>
                    <button class="btn" onclick="addEmail()">Agregar Email</button>
                </div>
                <div id="emailsList"></div>
            </div>
        </div>

        <!-- Monitors -->
        <div class="card">
            <h2>üëÅÔ∏è Monitoreos</h2>
            <div class="grid">
                <div>
                    <div class="form-group">
                        <label>Bot</label>
                        <select id="monitorBot">
                            <option value="">Selecciona un bot</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <select id="monitorEmail">
                            <option value="">Selecciona un email</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Carpeta</label>
                        <input id="monitorFolder" placeholder="INBOX" value="INBOX">
                    </div>
                    <div class="form-group">
                        <label>Intervalo (segundos)</label>
                        <input id="monitorInterval" type="number" value="300" placeholder="300">
                    </div>
                    <button class="btn" onclick="addMonitor()">Crear Monitoreo</button>
                </div>
                <div id="monitorsList"></div>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://' + window.location.host;

        async function loadBots() {
            const res = await fetch(`${API}/bots`);
            const bots = await res.json();
            const html = bots.map(b => `
                <div class="item">
                    <div class="item-content">
                        <div class="item-title">${b.name}</div>
                        <div class="item-info">Chat ID: ${b.chat_id}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('botsList').innerHTML = html || '<p style="color:#999;">Sin bots configurados</p>';
            updateBotSelect(bots);
        }

        async function loadEmails() {
            const res = await fetch(`${API}/emails`);
            const emails = await res.json();
            const html = emails.map(e => `
                <div class="item">
                    <div class="item-content">
                        <div class="item-title">${e.email}</div>
                        <div class="item-info">${e.imap_server}:${e.imap_port}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('emailsList').innerHTML = html || '<p style="color:#999;">Sin emails configurados</p>';
            updateEmailSelect(emails);
        }

        async function loadMonitors() {
            const res = await fetch(`${API}/monitors`);
            const monitors = await res.json();
            const bots = await fetch(`${API}/bots`).then(r => r.json());
            const emails = await fetch(`${API}/emails`).then(r => r.json());
            
            const html = monitors.map(m => {
                const bot = bots.find(b => b.id === m.bot_id);
                const email = emails.find(e => e.id === m.email_id);
                return `
                    <div class="item">
                        <div class="item-content">
                            <div class="item-title">${bot?.name || 'Bot'} ‚Üí ${email?.email || 'Email'}</div>
                            <div class="item-info">Carpeta: ${m.folder} | Intervalo: ${m.check_interval}s</div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('monitorsList').innerHTML = html || '<p style="color:#999;">Sin monitoreos configurados</p>';
        }

        function updateBotSelect(bots) {
            const select = document.getElementById('monitorBot');
            const opts = '<option value="">Selecciona un bot</option>' + 
                        bots.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            select.innerHTML = opts;
        }

        function updateEmailSelect(emails) {
            const select = document.getElementById('monitorEmail');
            const opts = '<option value="">Selecciona un email</option>' + 
                        emails.map(e => `<option value="${e.id}">${e.email}</option>`).join('');
            select.innerHTML = opts;
        }

        function showAlert(msg, type) {
            const alerts = document.getElementById('alerts');
            const div = document.createElement('div');
            div.className = `alert alert-${type}`;
            div.textContent = msg;
            alerts.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        async function addBot() {
            const data = {
                name: document.getElementById('botName').value,
                token: document.getElementById('botToken').value,
                chat_id: document.getElementById('botChatId').value
            };
            
            if (!data.name || !data.token || !data.chat_id) {
                showAlert('Completa todos los campos', 'error');
                return;
            }

            const res = await fetch(`${API}/bots`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                showAlert('Bot agregado exitosamente', 'success');
                document.getElementById('botName').value = '';
                document.getElementById('botToken').value = '';
                document.getElementById('botChatId').value = '';
                loadBots();
            } else {
                showAlert('Error al agregar bot', 'error');
            }
        }

        async function addEmail() {
            const data = {
                email: document.getElementById('emailAddr').value,
                password: document.getElementById('emailPass').value,
                imap_server: document.getElementById('emailServer').value,
                imap_port: parseInt(document.getElementById('emailPort').value)
            };
            
            if (!data.email || !data.password || !data.imap_server) {
                showAlert('Completa todos los campos', 'error');
                return;
            }

            const res = await fetch(`${API}/emails`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                showAlert('Email agregado y verificado exitosamente', 'success');
                document.getElementById('emailAddr').value = '';
                document.getElementById('emailPass').value = '';
                document.getElementById('emailServer').value = '';
                document.getElementById('emailPort').value = '993';
                loadEmails();
            } else {
                const err = await res.json();
                showAlert(err.detail || 'Error al agregar email', 'error');
            }
        }

        async function addMonitor() {
            const data = {
                bot_id: parseInt(document.getElementById('monitorBot').value),
                email_id: parseInt(document.getElementById('monitorEmail').value),
                folder: document.getElementById('monitorFolder').value,
                check_interval: parseInt(document.getElementById('monitorInterval').value)
            };
            
            if (!data.bot_id || !data.email_id || !data.folder) {
                showAlert('Completa todos los campos', 'error');
                return;
            }

            const res = await fetch(`${API}/monitors`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                showAlert('Monitoreo creado exitosamente', 'success');
                document.getElementById('monitorBot').value = '';
                document.getElementById('monitorEmail').value = '';
                document.getElementById('monitorFolder').value = 'INBOX';
                document.getElementById('monitorInterval').value = '300';
                loadMonitors();
            } else {
                showAlert('Error al crear monitoreo', 'error');
            }
        }

        // Load on page load
        loadBots();
        loadEmails();
        loadMonitors();
        setInterval(() => {
            loadBots();
            loadEmails();
            loadMonitors();
        }, 5000);
    </script>
</body>
</html>
